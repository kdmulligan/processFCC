---
title: "How to use the updated `processFCC` package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(processFCC)
```


Install and load the package with the following code:

```{r eval=FALSE, warning = FALSE}
install.packages("devtools")
library(devtools)
install_github("kdmulligan/processFCC")
library(processFCC)
```

One of the first things you will need to do is decide which time points of the 
FCC fixed broadband data you wish to use and process. Use `new_or_old_FCC()` to
check which dates are available and also the format (new or old) that should be 
used to process the data. The output of the function tells you the available 
dates, the format, the function to use to process the data, and the website if
you would like to read more.

Dates from December 2021 and prior use the old format whereas dates June 2022 
and more recent use the new format.

## New FCC data format

For a time point of data in the "new" format you will need functions: `avail_new_dates()`
and `rollup_new_FCC()`. The most efficient way to work with the new FCC data is the
public data application programming interface (API). When using the API you will
not have to download each data file individually from the website.

To do this you will have to create
an FCC User Registration account and then setup an API key. 
Two of the arguments in `rollup_new_FCC()` are your FCC account username and
your API key so this step is necessary in order to use the function. To create 
an account go to <https://broadbandmap.fcc.gov/login> and then click "Create an 
account" in the bottom right of the sign-in box.

Once you are logged into your account, click on your username in the top right corner. Then select the "Manage API Access" option. From this new page, click 
the "Generate" button to generate a new API token. Copy the token value and 
save it in a separate location. You will need this key in `rollup_new_FCC()`
to access the database.

For more information visit the [FCC API Instructions](https://us-fcc.app.box.com/v/bdc-public-data-api-spec)

Use `avail_new_dates()` to see what dates are available in the new FCC data format

```{r, eval=FALSE, warning = FALSE}
avail_new_dates(
  fcc_username = ,
  api_key = 
)
```

If you already know what date you would like to process you can move right to using `rollup_new_FCC()`

```{r, eval=FALSE, warning = FALSE}
rollup_new_FCC(
  wd = getwd(),
  fcc_username,
  api_key,
  get_year = "2021",
  get_month = "Jun",
  states = c("IL", "WI"),
  geogr = "cb",
  tech_exc = c("60", "70"),
  thresh_down = c(25, 25, 50, 100, 100),
  thresh_up = c(3, 5, 10, 10, 100),
  save_csv = FALSE
)
```


## Old FCC data format

If you wish to use a time point of data in the "old" format you will need to use
the following functions: `old_FCC_links()`, `csv_to_sql_db()`, and 
`rollup_old_FCC()`.

`old_FCC_links()` will given you a link for where you should download the data
set of interest. If `year` and `month` are left NULL then all potential years
and months will be output. Set `most_recent` to TRUE in order to only get the
link for the most recent version of the dataset(s), otherwise all available
versions will be output.

```{r, eval=FALSE, warning = FALSE}
old_FCC_links(year = 2020, month = NULL, most_recent = TRUE)
```

Based on the year and month combination you would like to process, copy the
link from the `old_FCC_links()` output, go to the website, and download the US - 
Fixed with Satellite data set under the "Fixed Broadband Deployment Block Data" 
header. The code should still work if you decide to work with a state-level data 
set but the code is originally designed to work with the U.S. data set.
Once on the website from `old_FCC_links()`, the link for the csv file 
may take you to dropbox. In this case you will need to click on the 3 dots icon 
on the top bar of the page and then click download.

Move the downloaded ZIP file and unzip the inner CSV file to the same working 
directory as your R file for processing the data otherwise you should set the 
argument `csv_file` to the full direct path to the CSV file.

```{r, eval=FALSE, warning = FALSE}
fcc_con <- dbConnect(SQLite(), dbname = "fcc.sqlite")
dbListTables(fcc_con)

csv_to_sql_db(csv_file = "C:/Users/kaile/Downloads/AK-Fixed-Jun2020-v2.csv", 
              con = fcc_con, 
              pre_process_size = 1000, chunk_size = 50000, 
              show_progress_bar = TRUE,
              year = 2020, month = "Jun")
```

The output of `rollup_old_FCC()` is a tibble with the specifications from the 
function arguments. 

In this call of
`rollup_FCC`, the June 2018 FCC data is rolled up to the Census Tract
level excluding technology codes 0, 60, and 70 and looks at 5 threshold
combinations for download/upload speeds: 25/3, 25/5, 50/5, 75/10, and
100/100 Mbps. The processed data will count the number of providers
within the census tract providing broadband at the thresholds.

```{r, eval=FALSE, warning = FALSE}
processed_dat <- rollup_old_FCC(
    con = fcc_con,
    table_in_con = "fcc_2020_Jun",
    year = 2020, month = "Jun",
    geogr = "ct",
    tech_exc = c("0", "60", "70"),
    thresh_down = c(25, 25, 50, 75, 100),
    thresh_up = c(3, 5, 5, 10, 100)
  )
head(processed_dat)
```

If you are done working with the SQLite database, be sure to disconnect from the 
database with `dbDisconnect()`. You may also want to remove the sqlite, zip, 
and raw csv files from your working directory because they are considerably 
large and take up a lot of space.

```{r, eval = FALSE}
dbDisconnect(con)
file.remove("fcc.sqlite")
```


